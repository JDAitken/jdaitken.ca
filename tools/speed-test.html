<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Speed Test | JD Aitken</title>
  <meta name="description" content="Run a quick speed and SEO test using Google Lighthouse data." />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: light;
      --text: #0f172a;
      --muted: #6b7280;
      --border: #e5e7eb;
      --card: #f9fafb;
      --accent: #111827;
      --success: #0f9f6e;
    }
    body { font-family: "DM Sans", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; max-width: 1100px; margin: 40px auto; padding: 0 16px 60px; color: var(--text); background: #ffffff; }
    body.is-fullscreen { max-width: none; margin: 0; padding: 0; background: #081427; color: #EAF2FF; }
    h1 { font-size: 32px; margin-bottom: 6px; letter-spacing: -0.4px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items: center; margin-top: 18px; }
    input { flex:1; min-width:260px; padding:12px 14px; border:1px solid var(--border); border-radius:12px; font-size: 16px; }
    input:focus { outline: 2px solid rgba(17,24,39,0.18); border-color: rgba(17,24,39,0.38); }
    button { padding:12px 14px; border-radius:12px; border:1px solid var(--accent); background: var(--accent); color:#fff; cursor:pointer; font-weight: 700; letter-spacing:-0.1px; transition: transform 140ms ease, box-shadow 140ms ease; }
    button:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(15,23,42,0.12); }
    button:disabled { opacity: 0.6; cursor: not-allowed; transform:none; box-shadow:none; }
    button.secondary { background:#fff; color:var(--text); border-color: var(--border); }
    button.secondary.is-active { border-color: var(--accent); color: var(--accent); }
    .card { border:1px solid var(--border); border-radius:16px; padding:16px; margin-top:16px; background: var(--card); }
    .muted { color:var(--muted); }
    .grid { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px; }
    @media (max-width: 640px){ .grid{ grid-template-columns: 1fr; } }
    .big { font-size: 28px; font-weight: 700; line-height: 1.2; }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid var(--border); margin-left:8px; font-size:12px; background: #fff; }
    ul { margin: 10px 0 0; padding-left: 18px; }
    .fade-in { animation: fadeIn 280ms ease-out forwards; }
    .fade-up { animation: fadeUp 320ms ease-out forwards; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(6px);} to {opacity:1; transform: translateY(0);} }
    @keyframes fadeUp { from { opacity:0; transform: translateY(8px);} to {opacity:1; transform: translateY(0);} }
    @media (prefers-reduced-motion: reduce) {
      .fade-in, .fade-up { animation: none; }
      button { transition: none; }
    }

    /* Analyzing */
    .full-section { min-height: 100vh; display:flex; align-items:center; justify-content:center; background: radial-gradient(circle at 20% 20%, rgba(47,128,255,0.12), transparent 35%), radial-gradient(circle at 80% 60%, rgba(90,167,255,0.12), transparent 32%), linear-gradient(135deg, var(--bg1, #081427), var(--bg2, #0B1E3A)); color: #EAF2FF; padding: 48px 16px; box-sizing:border-box; }
    .analyzing-shell { width: min(760px, 94vw); background: rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.06); border-radius:18px; padding:28px; box-shadow: 0 18px 60px rgba(0,0,0,0.28); }
    .analyzing-title { font-size: 30px; margin:0 0 6px; }
    .analyzing-sub { color: rgba(234,242,255,0.72); margin:0; }
    .spinner { width:22px; height:22px; border:2px solid rgba(226,232,240,0.3); border-top-color:#EAF2FF; border-radius:50%; animation: spin 840ms linear infinite; }
    @keyframes spin { to { transform: rotate(360deg);} }
    .progress-shell { background: rgba(255,255,255,0.08); border-radius: 14px; height: 16px; margin: 20px 0 12px; overflow:hidden; position:relative; box-shadow: 0 0 0 1px rgba(255,255,255,0.04), 0 12px 30px rgba(47,128,255,0.18); }
    .progress-bar { height:100%; width:0%; background: linear-gradient(90deg, #2F80FF, #5AA7FF); transition: width 280ms ease; }
    .progress-label { font-size:13px; color: rgba(234,242,255,0.8); }
    .shimmer { position: relative; overflow: hidden; background: rgba(255,255,255,0.05); border-radius:12px; min-height: 64px; }
    .shimmer::after { content:""; position:absolute; inset:0; transform: translateX(-100%); background: linear-gradient(90deg, transparent, rgba(255,255,255,0.14), transparent); animation: shimmer 1200ms ease-in-out infinite; }
    @keyframes shimmer { 100% { transform: translateX(100%);} }
    .skeleton-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:10px; margin-top: 12px; }
    .status-steps { display:flex; gap:6px; flex-wrap:wrap; margin-top: 10px; }
    .status-dot { width: 6px; height:6px; border-radius:50%; background: rgba(226,232,240,0.3); }

    /* Gate */
    .report-gate { position: relative; margin-top:0; color: var(--gate-text); background: radial-gradient(circle at 20% 20%, rgba(47,128,255,0.12), transparent 35%), radial-gradient(circle at 80% 60%, rgba(90,167,255,0.12), transparent 32%), linear-gradient(135deg, var(--gate-bg), var(--gate-bg2)); overflow:hidden; min-height:100vh; display:flex; align-items:center; }
    .report-gate::before { content:""; position:absolute; inset:0; background-image: radial-gradient(circle at 15% 10%, rgba(255,255,255,0.06), transparent 35%), radial-gradient(circle at 85% 90%, rgba(255,255,255,0.05), transparent 30%); opacity:0.8; pointer-events:none; }
    .gate-inner { position: relative; max-width: 980px; margin: 0 auto; padding: 88px 24px; z-index:1; width:100%; box-sizing:border-box; }
    @media (max-width: 720px){ .gate-inner { padding:56px 18px; } }
    .gate-label { text-transform: uppercase; letter-spacing: 0.2em; font-size: 11px; color: var(--gate-muted); margin-bottom: 12px; }
    .gate-headline { font-size: 30px; margin: 0 0 8px; line-height: 1.2; }
    .gate-sub { margin: 0 0 10px; color: var(--gate-muted); max-width: 680px; }
    .gate-trust { margin: 0 0 18px; color: var(--gate-muted); font-size: 14px; }
    .gate-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap:16px; align-items: stretch; }
    .gate-card { background: var(--gate-card); color: #0f172a; border:1px solid var(--gate-card-border); border-radius:18px; padding:24px; box-shadow: 0 14px 30px rgba(15,23,42,0.14); }
    .gate-card h3 { margin:0 0 10px; font-size: 20px; }
    .gate-form { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); gap:12px; }
    .gate-form input[type="email"], .gate-form input[type="text"], .gate-form input[type="tel"], .gate-form select { width:100%; padding:12px 12px; border-radius:12px; border:1px solid var(--border); font-size: 15px; box-sizing:border-box; }
    .gate-form .full-row { grid-column: 1 / -1; }
    .gate-form .full-span { grid-column: 1 / -1; }
    .gate-form .hp-field { display:none; }
    .gate-button { width: 100%; height: 52px; margin-top: 4px; background: var(--gate-accent); border-color: var(--gate-accent); color: #fff; text-transform: uppercase; letter-spacing: 0.05em; box-shadow: 0 10px 28px rgba(47,128,255,0.32); }
    .gate-button:hover { background: var(--gate-accent2); border-color: var(--gate-accent2); }
    .gate-button:focus-visible { outline: 3px solid rgba(47,128,255,0.45); outline-offset: 2px; }
    .gate-micro { font-size: 12px; color: var(--muted); margin-top: 6px; }
    .preview-label { font-size:12px; letter-spacing: 0.05em; text-transform: uppercase; color: var(--gate-muted); margin-bottom: 8px; }
    .preview-lock { font-size: 12px; color: var(--gate-muted); margin-top: 6px; }
    .preview-list { margin: 10px 0 0; padding-left: 18px; color: var(--gate-text); }
    .ring { display:flex; align-items:center; gap:12px; }
    .ring svg { width: 96px; height: 96px; }
    .ring-number { font-size: 30px; font-weight: 700; }
    .ring-caption { color: var(--gate-muted); font-size: 13px; }
    .fade-block { animation: fadeUp 360ms ease both; }
    .cta-card { margin-top:12px; padding:12px; border-radius:12px; background: rgba(47,128,255,0.08); border:1px dashed rgba(255,255,255,0.16); color: var(--gate-text); }
    .cta-card a { color: #fff; font-weight: 700; }
    .gate-preview { background: linear-gradient(160deg, rgba(8,20,39,0.7), rgba(12,34,68,0.55)); border:1px solid rgba(255,255,255,0.18); border-radius:16px; padding:16px; }
    .intro-wrap { transition: opacity 200ms ease; }
    body.is-gate .intro-wrap, body.is-fullscreen .intro-wrap { display:none; }

    @media (prefers-reduced-motion: reduce) {
      .spinner { animation: none; }
      .progress-bar { transition: none; }
      .shimmer::after { animation: none; }
      .fade-block { animation: none; }
    }
  </style>
</head>
<body>

  <div class="intro-wrap">
    <h1>Speed + SEO Test</h1>
    <p class="muted">Powered by Google Lighthouse data (PageSpeed Insights). Enter a URL to run a quick audit.</p>

    <div class="row">
      <input id="url" placeholder="Enter your website URL" autocomplete="url" inputmode="url" value="https://jdaitken.ca" />
      <button id="runBtn">Run Free Test</button>
    </div>

    <div id="status" class="card muted" style="display:none;"></div>
  </div>
  <div id="results" style="display:none;"></div>

<script>
  const strategy = "mobile";
  let currentReport = null;
  let progressTimer = null;
  let messageTimer = null;
  let readyTimer = null;
  const urlInput = document.getElementById("url");
  const statusEl = document.getElementById("status");
  const resultsEl = document.getElementById("results");
  const runBtn = document.getElementById("runBtn");
  const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  const normalizeUrl = (value) => {
    if (!value) return null;
    let next = value.trim();
    if (!next) return null;
    if (!/^https?:\/\//i.test(next)) {
      next = `https://${next}`;
    }
    try {
      return new URL(next).href;
    } catch (err) {
      return null;
    }
  };

  const score100 = (x) => (typeof x === "number" ? Math.round(x * 100) : null);

  const auditValue = (lhr, auditId, asNumber = false) => {
    const a = lhr?.audits?.[auditId];
    if (!a) return null;
    if (asNumber) return a.numericValue ?? null;
    return a.displayValue ?? a.title ?? null;
  };

  const formatMs = (ms) => {
    if (typeof ms !== "number") return "—";
    if (ms >= 1000) return (ms / 1000).toFixed(2) + " s";
    return Math.round(ms) + " ms";
  };

  const formatCls = (x) => {
    if (typeof x !== "number") return "—";
    return x.toFixed(3);
  };

  const topOpportunities = (lhr, max = 10) => {
    const audits = lhr?.audits || {};
    const items = Object.values(audits)
      .filter((a) => a && a.details && a.details.type === "opportunity" && typeof a.numericValue === "number")
      .sort((a, b) => (b.numericValue || 0) - (a.numericValue || 0))
      .slice(0, max)
      .map((a) => ({
        title: a.title,
        savingsMs: typeof a.numericValue === "number" ? Math.round(a.numericValue) : null,
      }));
    return items;
  };

  const buildReportObject = (lhr, urlValue, strategyValue) => {
    const perf = score100(lhr?.categories?.performance?.score);
    const seo = score100(lhr?.categories?.seo?.score);
    const lcpMs = auditValue(lhr, "largest-contentful-paint", true);
    const inpMs = auditValue(lhr, "interaction-to-next-paint", true);
    const cls = auditValue(lhr, "cumulative-layout-shift", true);
    const opportunities = topOpportunities(lhr, 10);

    return {
      url: urlValue,
      strategy: strategyValue,
      perfScore: perf,
      seoScore: seo,
      lcpMs,
      inpMs,
      cls,
      opportunities,
    };
  };

  const buildReportText = (report, { name = "" } = {}) => {
    const friendlyName = name || "there";
    const perfText = typeof report.perfScore === "number" ? `${report.perfScore}/100` : "—";
    const seoText = typeof report.seoScore === "number" ? `${report.seoScore}/100` : "—";
    const opps = report.opportunities?.slice(0, 10) || [];
    const oppCount = opps.length;
    const lines = [
      `Hi ${friendlyName},`,
      ``,
      `Here's your report for: ${report.url}`,
      `Strategy: mobile`,
      `Performance: ${perfText}`,
      `We found ${oppCount > 0 ? oppCount + " opportunities" : "a few quick wins"}.`,
      ``,
      `Core Web Vitals (lab):`,
      `  LCP: ${formatMs(report.lcpMs)}`,
      `  INP: ${formatMs(report.inpMs)}`,
      `  CLS: ${formatCls(report.cls)}`,
      ``,
      `Full report:`,
      `SEO Score: ${seoText}`,
      ``,
      `Top 10 opportunities:`,
    ];

    if (opps.length) {
      opps.forEach((opp, idx) => {
        const savings = typeof opp.savingsMs === "number" ? ` (~${formatMs(opp.savingsMs)})` : "";
        lines.push(`${idx + 1}) ${opp.title}${savings}`);
      });
    } else {
      lines.push("No major opportunities detected.");
    }

    lines.push(
      "",
      "If you want help fixing these, reply to this email and I’ll send 3 quick wins.",
      "",
      "— JD (jd@jdaitken.ca)"
    );

    return lines.join("\n");
  };

  const copyToClipboard = async (text) => {
    try {
      if (navigator.clipboard?.writeText) {
        await navigator.clipboard.writeText(text);
      } else {
        const textarea = document.createElement("textarea");
        textarea.value = text;
        textarea.setAttribute("readonly", "");
        textarea.style.position = "absolute";
        textarea.style.left = "-9999px";
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand("copy");
        document.body.removeChild(textarea);
      }
      return true;
    } catch (err) {
      console.error("Copy failed", err);
      return false;
    }
  };

  const buildScoreRing = (score) => {
    const safeScore = typeof score === "number" ? Math.max(0, Math.min(100, score)) : 0;
    const radius = 44;
    const circumference = 2 * Math.PI * radius;
    return `
      <div class="ring">
        <svg viewBox="0 0 120 120" aria-hidden="true" data-ring-svg data-ring-score="${safeScore}">
          <circle cx="60" cy="60" r="${radius}" stroke="rgba(255,255,255,0.15)" stroke-width="10" fill="none" />
          <circle cx="60" cy="60" r="${radius}" stroke="var(--gate-accent)" stroke-width="10" fill="none" stroke-linecap="round" data-ring="true" stroke-dasharray="${circumference} ${circumference}" stroke-dashoffset="${circumference}" />
        </svg>
        <div>
          <div class="ring-number" data-ring-number>${safeScore}</div>
          <div class="ring-caption">Performance score</div>
        </div>
      </div>`;
  };

  const animateScoreRing = (container) => {
    const svg = container.querySelector('[data-ring-svg]');
    const ring = container.querySelector('[data-ring="true"]');
    const numberEl = container.querySelector('[data-ring-number]');
    if (!svg || !ring || !numberEl) return;
    const score = Number(svg.getAttribute('data-ring-score')) || 0;
    const radius = Number(ring.getAttribute('r')) || 44;
    const circumference = 2 * Math.PI * radius;
    const offset = circumference * (1 - score / 100);
    ring.style.strokeDasharray = `${circumference} ${circumference}`;
    if (!prefersReducedMotion) {
      ring.style.transition = 'stroke-dashoffset 900ms ease';
    }
    requestAnimationFrame(() => {
      ring.style.strokeDashoffset = offset;
    });
    if (prefersReducedMotion) {
      numberEl.textContent = Math.round(score);
      return;
    }
    let current = 0;
    const increment = Math.max(1, Math.round(score / 40));
    const counter = setInterval(() => {
      current += increment;
      if (current >= score) {
        numberEl.textContent = Math.round(score);
        clearInterval(counter);
      } else {
        numberEl.textContent = Math.round(current);
      }
    }, 20);
  };

  const clearTimers = () => {
    if (progressTimer) clearInterval(progressTimer);
    if (messageTimer) clearInterval(messageTimer);
    if (readyTimer) clearTimeout(readyTimer);
    progressTimer = null;
    messageTimer = null;
    readyTimer = null;
  };

  const renderAnalyzing = () => {
    document.body.classList.add("is-fullscreen");
    resultsEl.style.display = "block";
    const messages = [
      "Checking performance…",
      "Measuring Core Web Vitals…",
      "Finding quick wins…",
      "Generating report…",
    ];
    resultsEl.innerHTML = `
      <section class="full-section fade-up">
        <div class="analyzing-shell">
          <div style="display:flex; align-items:center; gap:12px;">
            <div class="spinner" aria-hidden="true"></div>
            <div>
              <div class="analyzing-title">Analyzing your website…</div>
              <div class="analyzing-sub" data-analyzing-msg>${messages[0]}</div>
            </div>
          </div>
          <div class="progress-shell"><div class="progress-bar" data-progress-bar></div></div>
          <div class="progress-label" data-progress-label>0%</div>
          <div class="status-steps">
            <span class="status-dot"></span><span class="status-dot"></span><span class="status-dot"></span><span class="status-dot"></span>
          </div>
          <div class="skeleton-grid">
            <div class="shimmer"></div>
            <div class="shimmer"></div>
            <div class="shimmer"></div>
          </div>
        </div>
      </section>`;

    const msgEl = resultsEl.querySelector('[data-analyzing-msg]');
    let msgIndex = 0;
    messageTimer = setInterval(() => {
      msgIndex = (msgIndex + 1) % messages.length;
      if (msgEl) msgEl.textContent = messages[msgIndex];
    }, 1200);

    const progressBar = resultsEl.querySelector('[data-progress-bar]');
    const progressLabel = resultsEl.querySelector('[data-progress-label]');
    const start = Date.now();
    const duration = 10000; // 10s to 85%
    progressTimer = setInterval(() => {
      const elapsed = Date.now() - start;
      const pct = Math.min(85, Math.round((elapsed / duration) * 85));
      if (progressBar) progressBar.style.width = `${pct}%`;
      if (progressLabel) progressLabel.textContent = `${pct}%`;
      if (elapsed >= duration) {
        clearInterval(progressTimer);
      }
    }, 140);
  };

  const renderGate = (report) => {
    clearTimers();
    const oppCount = Math.min(10, report.opportunities?.length || 0);
    const oppLabel = oppCount > 0 ? `${oppCount} opportunities` : "a few quick wins";
    document.body.classList.add('is-gate');
    document.body.classList.add('is-fullscreen');

    resultsEl.style.display = "block";
    resultsEl.innerHTML = `
      <section class="report-gate fade-up" style="--gate-bg:#081427;--gate-bg2:#0B1E3A;--gate-accent:#2F80FF;--gate-accent2:#5AA7FF;--gate-text:#EAF2FF;--gate-muted:rgba(234,242,255,0.72);--gate-card:#FFFFFF;--gate-card-border:rgba(15, 23, 42, 0.10); --bg1:#081427; --bg2:#0B1E3A; width:100vw; margin-left:calc(50% - 50vw);">
        <div class="gate-inner">
          <div class="gate-label">JD Aitken • Speed Report</div>
          <h2 class="gate-headline">Your report is ready — we found <span style="color: var(--gate-accent);">${oppLabel}</span>.</h2>
          <p class="gate-sub">Enter your details to receive the full report by email.</p>
          <p class="gate-trust">No spam. One report. Reply if you want help improving your site.</p>
          <div class="gate-grid fade-block">
            <div class="gate-card" data-gate-card>
              <h3>Send the full report</h3>
              <form class="gate-form" data-full-report-form novalidate>
                <input class="full-span" type="email" name="email" placeholder="Email (required)" autocomplete="email" required data-email aria-label="Email" />
                <input type="text" name="firstName" placeholder="First name (optional)" autocomplete="given-name" data-first aria-label="First name" />
                <input type="tel" name="phone" placeholder="Phone (optional)" autocomplete="tel" data-phone aria-label="Phone" />
                <select class="full-span" name="budget" data-budget aria-label="Monthly marketing budget (optional)">
                  <option value="">Select budget (optional)</option>
                  <option value="<500"><$500/mo</option>
                  <option value="500-1500">$500–$1,500/mo</option>
                  <option value="1500-5000">$1,500–$5,000/mo</option>
                  <option value="5000+">$5,000+/mo</option>
                </select>
                <input type="text" name="website" class="hp-field" autocomplete="off" tabindex="-1" aria-hidden="true" data-honeypot />
                <div class="full-row">
                  <button type="submit" class="gate-button" data-full-submit>SEND THE REPORT TO MY EMAIL</button>
                  <div class="gate-micro" data-full-status></div>
                  <div class="gate-micro">You’ll receive the report in under a minute.</div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </section>
    `;

    const emailInput = resultsEl.querySelector('[data-email]');
    if (emailInput) emailInput.focus();
    bindFullReportForm(report);
  };

  const setGateSuccess = (form, report, nameVal) => {
    const card = form.closest('[data-gate-card]');
    if (!card) return;
    const opps = report.opportunities?.slice(0, 10) || [];
    const oppList = opps.length
      ? `<ul class="preview-list" style="color:var(--gate-text); padding-left:18px; margin-top:8px;">${opps
          .map((o, idx) => `<li><strong>${idx + 1}.</strong> ${o.title} <span style="color:var(--gate-muted);">(${typeof o.savingsMs === "number" ? "~" + formatMs(o.savingsMs) : "est."})</span></li>`)
          .join("")}</ul>`
      : `<p class="preview-lock" style="margin-top:8px;">No major opportunities detected.</p>`;
    card.innerHTML = `
      <h3>Sent! Check your inbox.</h3>
      <p style="color:#0f172a; margin-top:6px;">If you don’t see it in 2 minutes, check spam — or email me directly.</p>
      <div class="full-actions" style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
        <button type="button" class="gate-button" data-copy-report>Copy report</button>
        <a href="mailto:jd@jdaitken.ca" class="secondary" style="padding:12px 14px; border-radius:12px; border:1px solid var(--gate-card-border); text-decoration:none; color:#0f172a; font-weight:700;">Email JD directly</a>
      </div>
      <div class="cta-card" style="margin-top:12px;">
        Want me to fix these? <a href="/contact.html">Book a quick call</a>.
      </div>
      <div class="gate-preview" style="margin-top:16px; color: var(--gate-text); background: linear-gradient(160deg, rgba(8,20,39,0.7), rgba(12,34,68,0.55)); border-color: rgba(255,255,255,0.18);">
        <div class="preview-label">Report preview</div>
        ${buildScoreRing(report.perfScore ?? 0)}
        <div class="metric" style="margin-top:10px; background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.12);">
          <div class="label" style="color: var(--gate-muted);">SEO score</div>
          <div class="value" style="color:#fff; font-size:22px;">${typeof report.seoScore === "number" ? report.seoScore + "/100" : "—"}</div>
        </div>
        <div class="preview-lock" style="margin-top:10px;">Top 10 opportunities:</div>
        ${oppList}
      </div>
    `;
    const copyBtn = card.querySelector('[data-copy-report]');
    if (copyBtn) {
      copyBtn.addEventListener('click', async () => {
        const text = buildReportText(report, { name: nameVal });
        const ok = await copyToClipboard(text);
        copyBtn.textContent = ok ? 'Copied!' : 'Copy report';
      });
    }
    animateScoreRing(card);
  };

  const bindFullReportForm = (report) => {
    const form = resultsEl.querySelector('[data-full-report-form]');
    if (!form) return;
    const emailInput = form.querySelector('[data-email]');
    const phoneInput = form.querySelector('[data-phone]');
    const firstInput = form.querySelector('[data-first]');
    const budgetSelect = form.querySelector('[data-budget]');
    const honeypotInput = form.querySelector('[data-honeypot]');
    const submitBtn = form.querySelector('[data-full-submit]');
    const status = form.querySelector('[data-full-status]');
    let isSubmitting = false;

    const setStatus = (message, { isError = false } = {}) => {
      if (!status) return;
      status.textContent = message || '';
      status.style.color = isError ? '#b91c1c' : '#4b5563';
      if (!message) status.textContent = '';
    };

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (isSubmitting) return;
      const emailVal = emailInput.value.trim();
      const phoneVal = (phoneInput?.value || '').trim();
      const firstVal = (firstInput?.value || '').trim();
      const lastVal = '';
      const budgetVal = (budgetSelect?.value || '').trim();
      const hp = (honeypotInput.value || '').trim();
      if (!emailVal) {
        setStatus('Enter your email to get the full report.', { isError: true });
        emailInput.focus();
        return;
      }
      if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(emailVal)) {
        setStatus('Enter a valid email.', { isError: true });
        emailInput.focus();
        return;
      }
      isSubmitting = true;
      submitBtn.disabled = true;
      setStatus('Sending your report…');

      const payload = {
        url: report.url,
        strategy: report.strategy,
        email: emailVal,
        name: firstVal,
        phone: phoneVal,
        firstName: firstVal,
        budget: budgetVal,
        website: hp,
        report: {
          perfScore: report.perfScore,
          seoScore: report.seoScore,
          lcpMs: report.lcpMs,
          inpMs: report.inpMs,
          cls: report.cls,
          opportunities: (report.opportunities || []).slice(0, 10),
        },
      };

      try {
        const res = await fetch('/api/lead-report.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || data?.success !== true) {
          throw new Error(data?.error || 'Unable to send right now. Please try again.');
        }
        setGateSuccess(form, report, firstVal || lastVal);
      } catch (err) {
        setStatus(err?.message || 'Unable to send right now.', { isError: true });
        submitBtn.disabled = false;
        isSubmitting = false;
        return;
      }
    });
  };

  const showError = (message) => {
    clearTimers();
    document.body.classList.remove('is-gate');
    document.body.classList.remove('is-fullscreen');
    resultsEl.style.display = "block";
    resultsEl.innerHTML = `<div class="card fade-in"><div class="big" style="margin-bottom:6px;">We hit a snag.</div><p class="muted" style="margin:0 0 6px;">${message}</p><button class="secondary" id="retryBtn">Try again</button></div>`;
    const retry = document.getElementById('retryBtn');
    if (retry) {
      retry.onclick = () => {
        statusEl.style.display = 'none';
        resultsEl.style.display = 'none';
      };
    }
  };

  async function run() {
    const normalized = normalizeUrl(urlInput.value);
    resultsEl.style.display = "none";
    currentReport = null;
    clearTimers();
    document.body.classList.remove('is-gate');
    document.body.classList.remove('is-fullscreen');

    if (!normalized) {
      statusEl.style.display = "block";
      statusEl.textContent = "Enter a valid URL starting with http:// or https://";
      urlInput.focus();
      return;
    }

    urlInput.value = normalized;
    statusEl.style.display = "none";
    runBtn.disabled = true;
    renderAnalyzing();

    const endpoint = `/api/psi.php?url=${encodeURIComponent(normalized)}&strategy=${encodeURIComponent(strategy)}`;

    let data;
    try {
      const res = await fetch(endpoint, { cache: "no-store" });
      data = await res.json();
      if (!res.ok) throw new Error(data?.error || "Request failed");
    } catch (e) {
      runBtn.disabled = false;
      showError(e?.message || "Unknown error");
      return;
    }

    const lhr = data?.lighthouseResult;
    currentReport = buildReportObject(lhr, normalized, strategy);

    if (progressTimer) {
      clearInterval(progressTimer);
      progressTimer = null;
    }
    const progressBar = resultsEl.querySelector('[data-progress-bar]');
    const progressLabel = resultsEl.querySelector('[data-progress-label]');
    if (progressBar) progressBar.style.width = '100%';
    if (progressLabel) progressLabel.textContent = '100% • Complete';

    readyTimer = setTimeout(() => {
      renderGate(currentReport);
      runBtn.disabled = false;
    }, prefersReducedMotion ? 0 : 650);
  }

  runBtn.onclick = run;
  urlInput.addEventListener("keydown", (event) => {
    if (event.key === "Enter") {
      event.preventDefault();
      run();
    }
  });

  const params = new URLSearchParams(window.location.search);
  const urlFromQuery = params.get("url");
  if (urlFromQuery) {
    const normalizedParam = normalizeUrl(urlFromQuery);
    urlInput.value = normalizedParam || urlFromQuery;
    if (normalizedParam) {
      run();
    } else {
      statusEl.style.display = "block";
      statusEl.textContent = "We couldn't read that URL from the link. Please update it and run again.";
    }
  }
</script>
</body>
</html>
